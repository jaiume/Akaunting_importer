{% extends "base.html.twig" %}

{% block title %}Import Statement - Akaunting Importer{% endblock %}

{% block styles %}
<style>
    .file-upload-zone {
        border: 3px dashed #dee2e6;
        border-radius: 1rem;
        padding: 3rem 2rem;
        text-align: center;
        transition: all 0.3s ease;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        cursor: pointer;
    }
    .file-upload-zone:hover {
        border-color: #667eea;
        background: linear-gradient(135deg, #f0f4ff 0%, #e8edff 100%);
    }
    .file-upload-zone.dragover {
        border-color: #667eea;
        background: linear-gradient(135deg, #e8edff 0%, #d5dfff 100%);
        transform: scale(1.01);
    }
    .file-upload-zone.has-file {
        border-color: #28a745;
        border-style: solid;
        background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
    }
    .file-upload-zone .upload-icon {
        font-size: 4rem;
        color: #6c757d;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }
    .file-upload-zone:hover .upload-icon {
        color: #667eea;
        transform: translateY(-5px);
    }
    .file-upload-zone.has-file .upload-icon {
        color: #28a745;
    }
    .file-info-display {
        display: none;
        margin-top: 1.5rem;
        padding: 1rem;
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .file-info-display.visible {
        display: block;
    }
    .detection-badge {
        font-size: 0.9rem;
        padding: 0.5rem 1rem;
    }
    .form-section {
        background: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-top: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        opacity: 0.5;
        pointer-events: none;
        transition: all 0.3s ease;
    }
    .form-section.enabled {
        opacity: 1;
        pointer-events: auto;
    }
    .form-section-title {
        font-weight: 600;
        color: #495057;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e9ecef;
    }
    .analyzing-spinner {
        display: none;
    }
    .analyzing-spinner.visible {
        display: inline-block;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ base_url }}dashboard">Dashboard</a></li>
                <li class="breadcrumb-item active">Import Statement</li>
            </ol>
        </nav>
        
        <h1 class="mb-4">
            <i class="bi bi-cloud-upload"></i> Import Statement
        </h1>
        
        {% if error %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            {% if error == 'missing_fields' %}
                Please fill in all required fields.
            {% elseif error == 'no_file' %}
                Please select a file to upload.
            {% elseif error == 'upload_error' %}
                There was an error uploading the file. Please try again.
            {% elseif error == 'invalid_file_type' %}
                Invalid file type. Please upload a PDF or CSV file.
            {% elseif error == 'invalid_processor' %}
                Invalid processor type. Please select a valid statement type.
            {% elseif error == 'file_too_large' %}
                File is too large. Maximum file size is 10MB.
            {% elseif error == 'server_error' %}
                A server error occurred. Please try again.
            {% else %}
                {{ error }}
            {% endif %}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endif %}
        
        <div class="row">
            <div class="col-lg-8">
                <form method="POST" action="{{ base_url }}import" enctype="multipart/form-data" id="importForm">
                    
                    <!-- Step 1: File Upload (Top, Prominent) -->
                    <div class="file-upload-zone" id="fileUploadZone">
                        <i class="bi bi-cloud-arrow-up upload-icon"></i>
                        <h4 class="mb-2">Drop your statement file here</h4>
                        <p class="text-muted mb-3">or click to browse</p>
                        <input type="file" class="d-none" id="import_file" name="import_file" accept=".pdf,.csv" required>
                        <button type="button" class="btn btn-outline-primary btn-lg" onclick="document.getElementById('import_file').click()">
                            <i class="bi bi-folder2-open"></i> Choose File
                        </button>
                        <p class="text-muted mt-3 mb-0 small">
                            <i class="bi bi-info-circle"></i> Supported: PDF and CSV files (max 10MB)
                        </p>
                        
                        <!-- File Info Display -->
                        <div class="file-info-display" id="fileInfoDisplay">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-file-earmark-check fs-2 text-success me-3" id="fileIcon"></i>
                                    <div class="text-start">
                                        <strong id="displayFileName">filename.csv</strong>
                                        <br><small class="text-muted" id="displayFileSize">0 KB</small>
                                    </div>
                                </div>
                                <div>
                                    <span class="analyzing-spinner" id="analyzingSpinner">
                                        <span class="spinner-border spinner-border-sm text-primary me-2"></span>
                                        Analyzing...
                                    </span>
                                    <span class="badge detection-badge bg-secondary" id="detectionBadge" style="display: none;">
                                        <i class="bi bi-magic"></i> <span id="detectionText">Detecting...</span>
                                    </span>
                                </div>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-secondary mt-2" onclick="clearFile()">
                                <i class="bi bi-x"></i> Remove
                            </button>
                        </div>
                    </div>
                    
                    <!-- Step 2: Form Fields (Enabled after file upload) -->
                    <div class="form-section" id="formSection">
                        <h5 class="form-section-title"><i class="bi bi-sliders"></i> Import Details</h5>
                        
                        <!-- Processor Type (Pre-selected, can override) -->
                        <div class="mb-3">
                            <label for="processor" class="form-label">Statement Type <span class="text-danger">*</span></label>
                            <select class="form-select" id="processor" name="processor" required>
                                <option value="">-- Select Statement Type --</option>
                                <option value="rbl_credit_card">RBL Credit Card</option>
                                <option value="rbl_bank">RBL Bank Account</option>
                            </select>
                            <small class="form-text text-muted" id="processorHint">
                                Auto-detected from file. Change if incorrect.
                            </small>
                        </div>
                        
                        <!-- Entity -->
                        <div class="mb-3">
                            <label for="entity_name" class="form-label">Entity <span class="text-danger">*</span></label>
                            <select class="form-select" id="entity_name" name="entity_name" required>
                                <option value="">-- Select Entity --</option>
                                {% for entity in entities %}
                                <option value="{{ entity.entity_name }}">{{ entity.entity_name }}{% if entity.description %} - {{ entity.description }}{% endif %}</option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted">The entity this account belongs to</small>
                        </div>
                        
                        <!-- Account -->
                        <div class="mb-3">
                            <label for="account_id" class="form-label">Account <span class="text-danger">*</span></label>
                            <select class="form-select" id="account_id" name="account_id" required disabled>
                                <option value="">-- Select Account --</option>
                            </select>
                            <small class="form-text text-muted">The bank account for this import</small>
                            <div id="accountLoading" class="spinner-border spinner-border-sm d-none" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        
                        <!-- Batch Name -->
                        <div class="mb-3">
                            <label for="batch_name" class="form-label">Batch Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="batch_name" name="batch_name" required placeholder="e.g., RBL CC Nov 2025">
                            <small class="form-text text-muted">A descriptive name for this import batch (auto-suggested)</small>
                        </div>
                        
                        <!-- Import Date/Time -->
                        <div class="mb-3">
                            <label for="batch_import_datetime" class="form-label">Import Date/Time <span class="text-danger">*</span></label>
                            <input type="datetime-local" class="form-control" id="batch_import_datetime" name="batch_import_datetime" required>
                            <small class="form-text text-muted">When this statement was generated</small>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <a href="{{ base_url }}dashboard" class="btn btn-secondary">
                                <i class="bi bi-x-circle"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" disabled>
                                <i class="bi bi-upload"></i> Upload and Create Batch
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-lightbulb"></i> Smart Import</h5>
                    </div>
                    <div class="card-body">
                        <p class="small text-muted">
                            <strong>How it works:</strong>
                        </p>
                        <ol class="small text-muted mb-0">
                            <li class="mb-2"><strong>Drop your file</strong> - We'll analyze it and detect the statement type automatically</li>
                            <li class="mb-2"><strong>Verify details</strong> - Check the detected type and select your entity/account</li>
                            <li class="mb-2"><strong>Import</strong> - We'll extract all transactions from your statement</li>
                        </ol>
                        
                        <hr>
                        
                        <h6 class="mt-3"><i class="bi bi-file-earmark-check text-success"></i> Supported Formats</h6>
                        <ul class="small mb-0">
                            <li><strong>RBL Credit Card</strong> - CSV or PDF statements</li>
                            <li><strong>RBL Bank Account</strong> - CSV or PDF statements</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set default datetime to now
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.getElementById('batch_import_datetime').value = now.toISOString().slice(0, 16);
    
    const fileInput = document.getElementById('import_file');
    const fileUploadZone = document.getElementById('fileUploadZone');
    const fileInfoDisplay = document.getElementById('fileInfoDisplay');
    const formSection = document.getElementById('formSection');
    const submitBtn = document.getElementById('submitBtn');
    const processorSelect = document.getElementById('processor');
    const batchNameInput = document.getElementById('batch_name');
    const analyzingSpinner = document.getElementById('analyzingSpinner');
    const detectionBadge = document.getElementById('detectionBadge');
    const detectionText = document.getElementById('detectionText');
    
    // Click to upload
    fileUploadZone.addEventListener('click', function(e) {
        if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT' && !e.target.closest('.file-info-display')) {
            fileInput.click();
        }
    });
    
    // Drag and drop
    fileUploadZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
        fileUploadZone.classList.add('dragover');
    });
    
    fileUploadZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        e.stopPropagation();
        fileUploadZone.classList.remove('dragover');
    });
    
    fileUploadZone.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        fileUploadZone.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            handleFileSelect(files[0]);
        }
    });
    
    fileInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            handleFileSelect(this.files[0]);
        }
    });
    
    async function handleFileSelect(file) {
        // Validate file type
        const validExtensions = ['.pdf', '.csv'];
        const fileExt = '.' + file.name.split('.').pop().toLowerCase();
        
        if (!validExtensions.includes(fileExt)) {
            alert('Please select a PDF or CSV file.');
            fileInput.value = '';
            return;
        }
        
        // Validate file size (10MB)
        if (file.size > 10 * 1024 * 1024) {
            alert('File size must be less than 10MB.');
            fileInput.value = '';
            return;
        }
        
        // Update UI to show file
        fileUploadZone.classList.add('has-file');
        fileInfoDisplay.classList.add('visible');
        
        document.getElementById('displayFileName').textContent = file.name;
        document.getElementById('displayFileSize').textContent = formatFileSize(file.size);
        
        // Update icon based on file type
        const fileIcon = document.getElementById('fileIcon');
        if (fileExt === '.pdf') {
            fileIcon.className = 'bi bi-file-earmark-pdf fs-2 text-danger me-3';
        } else {
            fileIcon.className = 'bi bi-filetype-csv fs-2 text-success me-3';
        }
        
        // Show analyzing spinner
        analyzingSpinner.classList.add('visible');
        detectionBadge.style.display = 'none';
        
        // Enable form section
        formSection.classList.add('enabled');
        
        // Analyze file
        try {
            const formData = new FormData();
            formData.append('file', file);
            
            const response = await fetch('{{ base_url }}api/analyze-file', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            analyzingSpinner.classList.remove('visible');
            
            if (result.success) {
                // Show detection badge
                detectionBadge.style.display = 'inline-block';
                
                if (result.processor) {
                    // Auto-select processor
                    processorSelect.value = result.processor;
                    
                    // Update badge
                    if (result.confidence === 'high') {
                        detectionBadge.className = 'badge detection-badge bg-success';
                        detectionText.textContent = result.processor === 'rbl_credit_card' ? 'RBL Credit Card' : 'RBL Bank';
                    } else {
                        detectionBadge.className = 'badge detection-badge bg-warning text-dark';
                        detectionText.textContent = 'Uncertain - Please verify';
                    }
                    
                    // Set suggested batch name
                    if (result.suggestedName) {
                        batchNameInput.value = result.suggestedName;
                    }
                } else {
                    detectionBadge.className = 'badge detection-badge bg-secondary';
                    detectionText.textContent = 'Could not detect - Please select';
                }
                
                updateSubmitButton();
            } else {
                detectionBadge.style.display = 'inline-block';
                detectionBadge.className = 'badge detection-badge bg-danger';
                detectionText.textContent = 'Analysis failed';
            }
        } catch (error) {
            console.error('Analysis error:', error);
            analyzingSpinner.classList.remove('visible');
            detectionBadge.style.display = 'inline-block';
            detectionBadge.className = 'badge detection-badge bg-secondary';
            detectionText.textContent = 'Could not detect - Please select';
        }
        
        updateSubmitButton();
    }
    
    // Clear file
    window.clearFile = function() {
        fileInput.value = '';
        fileUploadZone.classList.remove('has-file');
        fileInfoDisplay.classList.remove('visible');
        formSection.classList.remove('enabled');
        submitBtn.disabled = true;
        processorSelect.value = '';
        batchNameInput.value = '';
        detectionBadge.style.display = 'none';
        analyzingSpinner.classList.remove('visible');
    };
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }
    
    // Load accounts when entity is selected
    document.getElementById('entity_name').addEventListener('change', function() {
        const entityName = this.value;
        const accountSelect = document.getElementById('account_id');
        const loading = document.getElementById('accountLoading');
        
        if (!entityName) {
            accountSelect.disabled = true;
            accountSelect.innerHTML = '<option value="">-- Select Account --</option>';
            updateSubmitButton();
            return;
        }
        
        accountSelect.disabled = true;
        loading.classList.remove('d-none');
        accountSelect.innerHTML = '<option value="">Loading...</option>';
        
        // Fetch accounts via AJAX
        fetch(`{{ base_url }}api/accounts/${encodeURIComponent(entityName)}`)
            .then(response => response.json())
            .then(data => {
                loading.classList.add('d-none');
                accountSelect.innerHTML = '<option value="">-- Select Account --</option>';
                
                if (data.success && data.accounts) {
                    data.accounts.forEach(account => {
                        const option = document.createElement('option');
                        option.value = account.account_id;
                        let text = account.account_name;
                        if (account.account_type) {
                            text += ` (${account.account_type})`;
                        }
                        if (account.currency) {
                            text += ` - ${account.currency}`;
                        }
                        option.textContent = text;
                        accountSelect.appendChild(option);
                    });
                    accountSelect.disabled = false;
                } else {
                    accountSelect.innerHTML = '<option value="">No accounts found</option>';
                }
                updateSubmitButton();
            })
            .catch(error => {
                loading.classList.add('d-none');
                accountSelect.innerHTML = '<option value="">Error loading accounts</option>';
                console.error('Error:', error);
                updateSubmitButton();
            });
    });
    
    // Update submit button state
    function updateSubmitButton() {
        const hasFile = fileInput.files.length > 0;
        const hasProcessor = processorSelect.value !== '';
        const hasEntity = document.getElementById('entity_name').value !== '';
        const hasAccount = document.getElementById('account_id').value !== '';
        const hasBatchName = batchNameInput.value.trim() !== '';
        
        submitBtn.disabled = !(hasFile && hasProcessor && hasEntity && hasAccount && hasBatchName);
    }
    
    // Add event listeners for form validation
    processorSelect.addEventListener('change', updateSubmitButton);
    document.getElementById('entity_name').addEventListener('change', updateSubmitButton);
    document.getElementById('account_id').addEventListener('change', updateSubmitButton);
    batchNameInput.addEventListener('input', updateSubmitButton);
});
</script>
{% endblock %}
