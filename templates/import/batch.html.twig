{% extends "base.html.twig" %}

{% block title %}Batch Details - {{ batch.batch_name }} - Akaunting Importer{% endblock %}

{% block styles %}
<style>
    .status-badge {
        font-size: 0.875rem;
    }
    .transaction-table {
        font-size: 0.9rem;
    }
    .amount-credit {
        color: #198754;
    }
    .amount-debit {
        color: #dc3545;
    }
    .batch-summary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 0.5rem;
    }
    /* Default border for all rows */
    .transaction-table tbody tr {
        border-bottom: 1px solid #e9ecef;
    }
    /* Main transaction rows - darker border to separate transaction groups */
    .transaction-table tbody tr.transaction-row {
        border-bottom: 2px solid #adb5bd;
    }
    /* When transaction has visible sub-rows, lighter border between them */
    .transaction-table tbody tr.transaction-row.has-match {
        border-bottom: 1px solid #e9ecef;
    }
    .transaction-table tbody tr.row-odd td {
        background-color: rgba(0, 0, 0, 0.02);
    }
    .transaction-table tbody tr.row-even td {
        background-color: #fff;
    }
    /* Match row - part of transaction group, gets dark border at bottom */
    .match-row {
        font-size: 0.85rem;
    }
    .match-row td {
        padding-top: 0.25rem !important;
        padding-bottom: 0.25rem !important;
        color: #6c757d;
        font-style: italic;
        border-bottom: 2px solid #adb5bd;
    }
    /* Push row - light dashed divider within group */
    .push-row td {
        padding: 0 !important;
        border-top: 1px dashed #dee2e6;
        border-bottom: 2px solid #adb5bd;
    }
    .push-row .push-form {
        background: linear-gradient(135deg, #f0f7ff 0%, #e8f4fd 100%);
        border-radius: 0;
    }
    .push-row .form-label {
        font-weight: 500;
        color: #495057;
    }
    /* Replicate row - light dashed divider within group */
    .replicate-row td {
        padding: 0 !important;
        border-top: 1px dashed #f5c36d;
        border-bottom: 2px solid #adb5bd;
    }
    .replicate-row .replicate-form {
        border-radius: 0;
    }
    .replicate-row .form-label {
        font-weight: 500;
        color: #495057;
    }
    .btn-outline-primary.p-0, .btn-outline-secondary.p-0 {
        line-height: 1;
        font-size: 0.8rem;
    }
    .match-stats {
        font-size: 0.85rem;
    }
    .match-stats-bar {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        padding: 0.75rem 1rem;
    }
    .match-stats-bar .stat-item {
        display: inline-flex;
        align-items: center;
        margin-right: 1.5rem;
        font-size: 0.85rem;
    }
    .match-stats-bar .stat-label {
        color: #6c757d;
        margin-right: 0.35rem;
    }
    .match-stats-bar .stat-value {
        font-weight: 600;
    }
    .match-stats-bar .confidence-group {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    .match-badge {
        font-size: 0.7rem;
        vertical-align: middle;
    }
    .spin {
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ base_url }}dashboard">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{{ base_url }}import">Import</a></li>
                <li class="breadcrumb-item active">Batch #{{ batch.batch_id }}</li>
            </ol>
        </nav>
        
        <h1 class="mb-4">
            <i class="bi bi-file-earmark-text"></i> {{ batch.batch_name }}
            {% if batch.is_archived %}
            <span class="badge bg-secondary fs-6"><i class="bi bi-archive"></i> Archived</span>
            {% endif %}
        </h1>
        
        {% if success %}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            {% if success == 'uploaded' %}
                <i class="bi bi-check-circle"></i> File uploaded successfully! Click "Process Batch" to extract transactions.
            {% elseif success == 'processed' %}
                <i class="bi bi-check-circle"></i> Batch processed successfully! {{ transactions|length }} transactions extracted.
            {% else %}
                <i class="bi bi-check-circle"></i> {{ success }}
            {% endif %}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}
        
        {% if error %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            {% if error == 'processing_failed' %}
                <i class="bi bi-exclamation-triangle"></i> Failed to process batch. Please check the file format and try again.
            {% else %}
                <i class="bi bi-exclamation-triangle"></i> {{ error }}
            {% endif %}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}
        
        <div class="card batch-summary mb-4">
            <div class="card-body">
                <div class="row">
                    <!-- Batch Info - Left Column -->
                    <div class="col-md-4">
                        <p class="mb-1"><strong>Entity:</strong> {{ batch.entity_name }}</p>
                        <p class="mb-1"><strong>Account:</strong> {{ batch.account_name }}</p>
                        <p class="mb-1"><strong>Import Type:</strong> {{ batch.batch_import_type }}</p>
                        <p class="mb-0"><strong>Processor:</strong> {{ batch.import_processor }}</p>
                    </div>
                    <!-- Batch Info - Middle Column -->
                    <div class="col-md-4">
                        <p class="mb-1"><strong>Status:</strong> 
                            {% if batch.status == 'pending' %}
                                <span class="badge bg-warning status-badge">Pending</span>
                            {% elseif batch.status == 'processing' %}
                                <span class="badge bg-info status-badge">Processing</span>
                            {% elseif batch.status == 'completed' %}
                                <span class="badge bg-success status-badge">Completed</span>
                            {% elseif batch.status == 'failed' %}
                                <span class="badge bg-danger status-badge">Failed</span>
                            {% endif %}
                        </p>
                        <p class="mb-1"><strong>Transactions:</strong> {{ batch.total_transactions }}</p>
                        <p class="mb-1"><strong>Import Date:</strong> {{ batch.batch_import_datetime }}</p>
                        <p class="mb-0 text-truncate" title="{{ batch.batch_import_filename }}"><strong>File:</strong> {{ batch.batch_import_filename }}</p>
                    </div>
                    <!-- Actions - Right Column -->
                    <div class="col-md-4 d-flex flex-column">
                        <div class="batch-actions bg-white bg-opacity-10 rounded p-2 flex-grow-1">
                            {% if batch.status == 'pending' %}
                            <!-- Primary: Process -->
                            <form method="POST" action="{{ base_url }}import/batch/{{ batch.batch_id }}/process" class="mb-2">
                                <button type="submit" class="btn btn-light btn-sm w-100">
                                    <i class="bi bi-play-fill"></i> Process Batch
                                </button>
                            </form>
                            {% elseif batch.status == 'failed' %}
                            <form method="POST" action="{{ base_url }}import/batch/{{ batch.batch_id }}/process" class="mb-2">
                                <button type="submit" class="btn btn-warning btn-sm w-100">
                                    <i class="bi bi-arrow-repeat"></i> Retry Processing
                                </button>
                            </form>
                            {% elseif batch.status == 'completed' %}
                                {% if can_match %}
                                <button type="button" id="matchBtn" class="btn btn-light btn-sm w-100 mb-2" onclick="startMatching()">
                                    <i class="bi bi-link-45deg"></i> Match with Akaunting
                                </button>
                                <!-- Progress display (hidden initially) -->
                                <div id="matchProgress" class="mb-2" style="display: none;">
                                    <div class="progress mb-1" style="height: 14px;">
                                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                                    </div>
                                    <small id="progressText" class="text-white-50 d-block text-center small"></small>
                                </div>
                                {% if match_stats.matched > 0 %}
                                <button type="button" id="clearBtn" class="btn btn-outline-light btn-sm w-100 mb-2" onclick="clearMatches()">
                                    <i class="bi bi-x-circle"></i> Clear Matches
                                </button>
                                {% endif %}
                                {% else %}
                                <div class="text-white-50 small mb-2">
                                    <i class="bi bi-info-circle"></i> {{ match_reason }}
                                </div>
                                {% endif %}
                            {% endif %}
                            
                            <!-- Secondary Actions Row -->
                            <div class="d-flex gap-1 mb-2">
                                {% if batch.status == 'completed' %}
                                <form method="POST" action="{{ base_url }}import/batch/{{ batch.batch_id }}/reimport" class="flex-fill" onsubmit="return confirm('This will delete all existing transactions and re-import from the original file. Continue?');">
                                    <button type="submit" class="btn btn-outline-light btn-sm w-100 py-1">
                                        <i class="bi bi-arrow-clockwise"></i> Re-import
                                    </button>
                                </form>
                                {% endif %}
                                {% if batch.is_archived %}
                                <form method="POST" action="{{ base_url }}import/batch/{{ batch.batch_id }}/unarchive" class="flex-fill">
                                    <button type="submit" class="btn btn-outline-light btn-sm w-100 py-1">
                                        <i class="bi bi-archive"></i> Unarchive
                                    </button>
                                </form>
                                {% else %}
                                <form method="POST" action="{{ base_url }}import/batch/{{ batch.batch_id }}/archive" class="flex-fill">
                                    <button type="submit" class="btn btn-outline-light btn-sm w-100 py-1">
                                        <i class="bi bi-archive"></i> Archive
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                            
                            <!-- Footer: Dashboard, Refresh & Delete -->
                            <div class="d-flex justify-content-between align-items-center pt-1 border-top border-white border-opacity-25">
                                <a href="{{ base_url }}dashboard" class="text-white-50 small text-decoration-none">
                                    <i class="bi bi-arrow-left"></i> Dashboard
                                </a>
                                <button type="button" id="refresh-cache-btn" class="btn btn-link btn-sm text-white-50 p-0 small" onclick="refreshVendorsCategories()">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                                <form method="POST" action="{{ base_url }}import/batch/{{ batch.batch_id }}/delete" class="d-inline"
                                      onsubmit="return confirm('Delete this batch permanently? All transactions and the uploaded file will be removed.');">
                                    <button type="submit" class="btn btn-link btn-sm text-white-50 p-0 small">
                                        <i class="bi bi-trash"></i> Delete
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        {% if batch.error_message %}
        <div class="alert alert-danger">
            <strong>Error Message:</strong> {{ batch.error_message }}
        </div>
        {% endif %}
        
        {% if batch.status == 'completed' and match_stats.total > 0 %}
        <div class="match-stats-bar mb-3 d-flex flex-wrap align-items-center justify-content-between">
            <div class="d-flex flex-wrap align-items-center">
                <span class="stat-item">
                    <span class="stat-label"><i class="bi bi-bar-chart me-1"></i>Total:</span>
                    <span class="stat-value">{{ match_stats.total }}</span>
                </span>
                <span class="stat-item">
                    <span class="stat-label">Matched:</span>
                    <span class="stat-value text-success">{{ match_stats.matched }}</span>
                </span>
                <span class="stat-item">
                    <span class="stat-label">Unmatched:</span>
                    <span class="stat-value text-muted">{{ match_stats.total - match_stats.matched }}</span>
                </span>
                <span class="confidence-group">
                    <span class="badge bg-success" title="High Confidence">H: {{ match_stats.high_confidence }}</span>
                    <span class="badge bg-warning text-dark" title="Medium Confidence">M: {{ match_stats.medium_confidence }}</span>
                    <span class="badge bg-danger" title="Low Confidence">L: {{ match_stats.low_confidence }}</span>
                </span>
            </div>
            <div class="d-flex align-items-center">
                {% set match_pct = (match_stats.matched / match_stats.total * 100)|round %}
                <div class="progress me-2" style="width: 100px; height: 8px;">
                    <div class="progress-bar bg-success" style="width: {{ match_pct }}%"></div>
                </div>
                <small class="text-muted">{{ match_pct }}%</small>
            </div>
        </div>
        {% endif %}
        
        {% if transactions|length > 0 %}
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-list-ul"></i> Transactions ({{ transactions|length }})</h5>
                <div class="d-flex align-items-center gap-3">
                    <label class="small mb-0 me-1">Filter:</label>
                    <select class="form-select form-select-sm" id="transactionFilter" onchange="applyTransactionFilter()" style="width: auto;">
                        <option value="all">All transactions</option>
                        <option value="hide-matched">Hide Matched</option>
                        <option value="hide-matched-pushed">Hide Matched & Pushed</option>
                    </select>
                    {% if match_stats.matched > 0 %}
                    <span class="badge bg-info">{{ match_stats.matched }} matched</span>
                    {% endif %}
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover transaction-table mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th style="width: 110px;">Date</th>
                                <th style="width: 120px;">Reference</th>
                                <th>Description</th>
                                <th class="text-end" style="width: 130px;">Amount</th>
                                <th style="width: 120px;">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for txn in transactions %}
                            {% set row_class = loop.index is odd ? 'row-odd' : 'row-even' %}
                            {% set is_pushed = txn.status == 'processed' %}
                            <tr class="transaction-row {{ row_class }}{% if txn.matched_akaunting_id %} has-match{% endif %}{% if is_pushed %} has-pushed{% endif %}">
                                <td>{{ txn.transaction_date }}</td>
                                <td>{{ txn.bank_ref ?: '-' }}</td>
                                <td>{{ txn.description }}</td>
                                <td class="text-end {% if txn.transaction_amount < 0 %}amount-debit{% else %}amount-credit{% endif %}">
                                    {{ txn.transaction_currency }} {{ txn.transaction_amount|number_format(2) }}
                                </td>
                                <td class="text-nowrap">
                                    <div class="d-flex align-items-center gap-1">
                                        {% if txn.status == 'pending' %}
                                            <span class="badge bg-warning">Pending</span>
                                        {% elseif txn.status == 'processed' %}
                                            {% if txn.replicated_to_entity_id %}
                                                {# Both pushed and replicated - show combined badge #}
                                                <span class="badge bg-success" title="Pushed: {{ txn.pushed_akaunting_transaction_number ?? 'N/A' }}&#10;Replicated: {{ txn.replicated_akaunting_transaction_number ?? 'N/A' }}">
                                                    Pushed + Replicated
                                                </span>
                                            {% else %}
                                                {# Only pushed - show pushed badge and replicate button #}
                                                <span class="badge bg-success" title="Pushed: {{ txn.pushed_akaunting_transaction_number ?? 'N/A' }}">Pushed</span>
                                                <button type="button" class="btn btn-sm btn-outline-secondary p-0 px-1" 
                                                        onclick="toggleReplicateRow({{ txn.transaction_id }})" 
                                                        title="Replicate to another entity">
                                                    <i class="bi bi-copy"></i>
                                                </button>
                                            {% endif %}
                                        {% elseif txn.status == 'error' %}
                                            <span class="badge bg-danger">Error</span>
                                        {% endif %}
                                        {% if not txn.matched_akaunting_id and can_match %}
                                            <button type="button" class="btn btn-sm btn-outline-primary p-0 px-1" 
                                                    onclick="togglePushRow({{ txn.transaction_id }})" 
                                                    title="Push to Akaunting">
                                                <i class="bi bi-cloud-upload"></i>
                                            </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {# Push to Akaunting row (hidden by default) #}
                            {% if not txn.matched_akaunting_id and can_match %}
                            <tr class="push-row {{ row_class }}" id="push-row-{{ txn.transaction_id }}" style="display: none;">
                                <td colspan="5">
                                    <div class="push-form p-3 border-top">
                                        <form id="push-form-{{ txn.transaction_id }}" onsubmit="return pushToAkaunting({{ txn.transaction_id }}, event)">
                                            <div class="row g-2 align-items-start">
                                                <div class="col-auto">
                                                    <label class="form-label small mb-0">Date</label>
                                                    <input type="date" class="form-control form-control-sm" name="date" 
                                                           value="{{ txn.transaction_date }}" required>
                                                </div>
                                                <div class="col-auto">
                                                    <label class="form-label small mb-0">Reference</label>
                                                    <input type="text" class="form-control form-control-sm" name="reference" 
                                                           value="{{ txn.bank_ref }}" style="width: 100px;">
                                                </div>
                                                <div class="col-auto">
                                                    <label class="form-label small mb-0">Type</label>
                                                    {# Bank: negative=expense, positive=income #}
                                                    {# Credit Card: negative=income, positive=expense #}
                                                    {% if account_type == 'credit_card' %}
                                                        {% set is_expense = txn.transaction_amount >= 0 %}
                                                    {% else %}
                                                        {% set is_expense = txn.transaction_amount < 0 %}
                                                    {% endif %}
                                                    <select class="form-select form-select-sm type-select" name="type" 
                                                            id="type-select-{{ txn.transaction_id }}"
                                                            onchange="onTypeChange({{ txn.transaction_id }}, {{ txn.transaction_amount }})"
                                                            data-amount="{{ txn.transaction_amount }}"
                                                            style="width: 95px;">
                                                        <option value="expense" {% if is_expense %}selected{% endif %}>Expense</option>
                                                        <option value="income" {% if not is_expense %}selected{% endif %}>Income</option>
                                                        {% if account_type == 'bank' %}
                                                        <option value="transfer">Transfer</option>
                                                        {% endif %}
                                                    </select>
                                                </div>
                                                {# Vendor/Customer and Category fields - shown for expense/income #}
                                                <div class="col contact-category-fields" id="contact-category-{{ txn.transaction_id }}">
                                                    <label class="form-label small mb-0" id="contact-label-{{ txn.transaction_id }}">{% if is_expense %}Vendor{% else %}Customer{% endif %}</label>
                                                    <select class="form-select form-select-sm contact-select" name="contact_id" 
                                                            id="contact-select-{{ txn.transaction_id }}"
                                                            data-description="{{ txn.description }}"
                                                            required>
                                                        <option value="">Loading...</option>
                                                    </select>
                                                    <input type="hidden" name="contact" id="contact-name-{{ txn.transaction_id }}">
                                                </div>
                                                <div class="col contact-category-fields" id="category-field-{{ txn.transaction_id }}">
                                                    <label class="form-label small mb-0">Category</label>
                                                    <select class="form-select form-select-sm category-select" name="category_id" 
                                                            id="category-select-{{ txn.transaction_id }}"
                                                            required>
                                                        <option value="">Loading...</option>
                                                    </select>
                                                    <input type="hidden" name="category_name" id="category-name-{{ txn.transaction_id }}">
                                                </div>
                                                {# Transfer fields - shown for transfer type, hidden by default #}
                                                <div class="col transfer-fields" id="source-field-{{ txn.transaction_id }}" style="display: none;">
                                                    <label class="form-label small mb-0">Source</label>
                                                    <select class="form-select form-select-sm" name="from_account_id" 
                                                            id="source-select-{{ txn.transaction_id }}">
                                                        <option value="">Loading...</option>
                                                    </select>
                                                </div>
                                                <div class="col transfer-fields" id="dest-field-{{ txn.transaction_id }}" style="display: none;">
                                                    <label class="form-label small mb-0">Destination</label>
                                                    <select class="form-select form-select-sm" name="to_account_id" 
                                                            id="dest-select-{{ txn.transaction_id }}">
                                                        <option value="">Loading...</option>
                                                    </select>
                                                </div>
                                                <div class="col-auto">
                                                    <label class="form-label small mb-0">Payment</label>
                                                    <select class="form-select form-select-sm payment-select" name="payment_method" 
                                                            id="payment-select-{{ txn.transaction_id }}"
                                                            style="width: 130px;"
                                                            required>
                                                        <option value="">Loading...</option>
                                                    </select>
                                                </div>
                                                {# Currency exchange section - stacked vertically when currencies differ #}
                                                <div class="col-auto" id="transfer-amounts-section-{{ txn.transaction_id }}">
                                                    {# Single amount field (shown when currencies are same) #}
                                                    <div id="single-amount-field-{{ txn.transaction_id }}">
                                                        <label class="form-label small mb-0">Amount</label>
                                                        <input type="number" step="0.01" class="form-control form-control-sm" name="amount" 
                                                               id="amount-input-{{ txn.transaction_id }}"
                                                               value="{{ txn.transaction_amount|abs|number_format(2, '.', '') }}" style="width: 100px;" required>
                                                    </div>
                                                    {# Stacked currency exchange fields (shown when currencies differ) #}
                                                    <div class="transfer-fields currency-exchange-stack" id="currency-exchange-stack-{{ txn.transaction_id }}" style="display: none;">
                                                        <div class="mb-1">
                                                            <label class="form-label small mb-0" id="source-amount-label-{{ txn.transaction_id }}">Source Amount</label>
                                                            <input type="number" step="0.01" class="form-control form-control-sm" 
                                                                   id="source-amount-display-{{ txn.transaction_id }}"
                                                                   value="{{ txn.transaction_amount|abs|number_format(2, '.', '') }}" style="width: 110px;" readonly>
                                                        </div>
                                                        <div class="mb-1">
                                                            <label class="form-label small mb-0" id="dest-amount-label-{{ txn.transaction_id }}">Dest Amount</label>
                                                            <input type="number" step="0.01" class="form-control form-control-sm" name="to_amount" 
                                                                   id="dest-amount-{{ txn.transaction_id }}"
                                                                   placeholder="0.00" style="width: 110px;"
                                                                   oninput="calculateExchangeRate({{ txn.transaction_id }})">
                                                        </div>
                                                        <div>
                                                            <label class="form-label small mb-0">Rate</label>
                                                            <input type="text" class="form-control form-control-sm" name="currency_rate_display"
                                                                   id="exchange-rate-display-{{ txn.transaction_id }}"
                                                                   style="width: 110px;" readonly placeholder="--">
                                                            <input type="hidden" name="currency_rate" id="exchange-rate-{{ txn.transaction_id }}" value="">
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-auto">
                                                    <button type="submit" class="btn btn-sm btn-primary">
                                                        <i class="bi bi-send"></i> Send
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="togglePushRow({{ txn.transaction_id }})">
                                                        <i class="bi bi-x"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endif %}
                            {% if txn.matched_akaunting_id %}
                            <tr class="match-row {{ row_class }}">
                                <td>{{ txn.matched_akaunting_date }}</td>
                                <td>{{ txn.matched_akaunting_number ?: '-' }}</td>
                                <td>
                                    {% if txn.matched_akaunting_contact %}
                                        {{ txn.matched_akaunting_contact }}
                                    {% endif %}
                                    {% if txn.matched_akaunting_category %}
                                        ({{ txn.matched_akaunting_category }})
                                    {% endif %}
                                    {% if not txn.matched_akaunting_contact and not txn.matched_akaunting_category %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    {{ txn.transaction_currency }} {{ txn.matched_akaunting_amount|number_format(2) }}
                                </td>
                                <td>
                                    <span class="badge {% if txn.match_confidence == 'high' %}bg-success{% elseif txn.match_confidence == 'medium' %}bg-warning text-dark{% else %}bg-danger{% endif %}">
                                        {{ txn.match_confidence|upper }}
                                    </span>
                                </td>
                            </tr>
                            {# Replicate to another entity row (hidden by default) #}
                            <tr class="replicate-row {{ row_class }}" id="replicate-row-{{ txn.transaction_id }}" style="display: none;">
                                <td colspan="5">
                                    <div class="replicate-form p-3 border-top" style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);">
                                        <div class="small text-muted mb-2"><i class="bi bi-copy"></i> Replicate to another entity</div>
                                        <form id="replicate-form-{{ txn.transaction_id }}" onsubmit="return replicateToEntity({{ txn.transaction_id }}, event)">
                                            <input type="hidden" name="source_transaction_id" value="{{ txn.transaction_id }}">
                                            {# Note: source vendor/category IDs not currently stored; mapping will use description-based matching #}
                                            <input type="hidden" name="source_vendor_id" value="">
                                            <input type="hidden" name="source_category_id" value="">
                                            <input type="hidden" name="source_currency" value="{{ akaunting_account_currency ?? 'TTD' }}">
                                            <div class="row g-2 align-items-start">
                                                <div class="col-auto">
                                                    <label class="form-label small mb-0">Entity</label>
                                                    <select class="form-select form-select-sm" name="entity_id" 
                                                            id="replicate-entity-{{ txn.transaction_id }}"
                                                            onchange="onReplicateEntityChange({{ txn.transaction_id }})"
                                                            style="width: 150px;" required>
                                                        <option value="">Select Entity...</option>
                                                    </select>
                                                    <input type="hidden" name="installation_id" id="replicate-installation-{{ txn.transaction_id }}">
                                                </div>
                                                <div class="col-auto">
                                                    <label class="form-label small mb-0">Account</label>
                                                    <select class="form-select form-select-sm" name="account_id" 
                                                            id="replicate-account-{{ txn.transaction_id }}"
                                                            style="width: 150px;" required>
                                                        <option value="">Select entity first</option>
                                                    </select>
                                                </div>
                                                <div class="col-auto">
                                                    <label class="form-label small mb-0">Reference</label>
                                                    <input type="text" class="form-control form-control-sm" name="reference" 
                                                           value="{{ txn.bank_ref }}" style="width: 100px;">
                                                </div>
                                                <div class="col-auto">
                                                    <label class="form-label small mb-0">Type</label>
                                                    {% set rep_is_expense = txn.transaction_amount < 0 %}
                                                    <select class="form-select form-select-sm" name="type" 
                                                            id="replicate-type-{{ txn.transaction_id }}"
                                                            onchange="onReplicateTypeChange({{ txn.transaction_id }})"
                                                            style="width: 95px;">
                                                        <option value="expense" {% if rep_is_expense %}selected{% endif %}>Expense</option>
                                                        <option value="income" {% if not rep_is_expense %}selected{% endif %}>Income</option>
                                                    </select>
                                                </div>
                                                <div class="col">
                                                    <label class="form-label small mb-0" id="replicate-contact-label-{{ txn.transaction_id }}">{% if rep_is_expense %}Vendor{% else %}Customer{% endif %}</label>
                                                    <select class="form-select form-select-sm" name="contact_id" 
                                                            id="replicate-contact-{{ txn.transaction_id }}" required>
                                                        <option value="">Select entity first</option>
                                                    </select>
                                                    <input type="hidden" name="contact_name" id="replicate-contact-name-{{ txn.transaction_id }}">
                                                </div>
                                                <div class="col">
                                                    <label class="form-label small mb-0">Category</label>
                                                    <select class="form-select form-select-sm" name="category_id" 
                                                            id="replicate-category-{{ txn.transaction_id }}" required>
                                                        <option value="">Select entity first</option>
                                                    </select>
                                                    <input type="hidden" name="category_name" id="replicate-category-name-{{ txn.transaction_id }}">
                                                </div>
                                                <div class="col-auto">
                                                    <label class="form-label small mb-0">Payment</label>
                                                    <select class="form-select form-select-sm" name="payment_method" 
                                                            id="replicate-payment-{{ txn.transaction_id }}"
                                                            style="width: 130px;" required>
                                                        <option value="">Select entity first</option>
                                                    </select>
                                                </div>
                                                {# Currency exchange section for replication - stacked vertically when currencies differ #}
                                                <div class="col-auto" id="replicate-amounts-section-{{ txn.transaction_id }}">
                                                    {# Single amount field (shown when currencies are same) #}
                                                    <div id="replicate-single-amount-field-{{ txn.transaction_id }}">
                                                        <label class="form-label small mb-0">Amount</label>
                                                        <input type="number" step="0.01" class="form-control form-control-sm" name="amount" 
                                                               id="replicate-amount-input-{{ txn.transaction_id }}"
                                                               value="{{ txn.transaction_amount|abs|number_format(2, '.', '') }}" style="width: 100px;" required>
                                                    </div>
                                                    {# Stacked currency exchange fields (shown when currencies differ) #}
                                                    <div class="replicate-currency-fields replicate-currency-exchange-stack" id="replicate-currency-exchange-stack-{{ txn.transaction_id }}" style="display: none;">
                                                        <div class="mb-1">
                                                            <label class="form-label small mb-0" id="replicate-source-amount-label-{{ txn.transaction_id }}">Source Amount</label>
                                                            <input type="number" step="0.01" class="form-control form-control-sm" 
                                                                   id="replicate-source-amount-display-{{ txn.transaction_id }}"
                                                                   value="{{ txn.transaction_amount|abs|number_format(2, '.', '') }}" style="width: 110px;" readonly>
                                                        </div>
                                                        <div class="mb-1">
                                                            <label class="form-label small mb-0" id="replicate-dest-amount-label-{{ txn.transaction_id }}">Dest Amount</label>
                                                            <input type="number" step="0.01" class="form-control form-control-sm" name="to_amount" 
                                                                   id="replicate-dest-amount-{{ txn.transaction_id }}"
                                                                   placeholder="0.00" style="width: 110px;"
                                                                   oninput="calculateReplicateExchangeRate({{ txn.transaction_id }})">
                                                        </div>
                                                        <div>
                                                            <label class="form-label small mb-0">Rate</label>
                                                            <input type="text" class="form-control form-control-sm" name="currency_rate_display"
                                                                   id="replicate-exchange-rate-display-{{ txn.transaction_id }}"
                                                                   style="width: 110px;" readonly placeholder="--">
                                                            <input type="hidden" name="currency_rate" id="replicate-exchange-rate-{{ txn.transaction_id }}" value="">
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-auto">
                                                    <label class="form-label small mb-0">Date</label>
                                                    <input type="date" class="form-control form-control-sm" name="date" 
                                                           value="{{ txn.transaction_date }}" required>
                                                </div>
                                                <div class="col-auto">
                                                    <button type="submit" class="btn btn-sm btn-warning">
                                                        <i class="bi bi-copy"></i> Replicate
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleReplicateRow({{ txn.transaction_id }})">
                                                        <i class="bi bi-x"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% else %}
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="bi bi-inbox fs-1 text-muted"></i>
                <p class="text-muted mt-3 mb-0">
                    {% if batch.status == 'pending' %}
                        No transactions extracted yet. Click "Process Batch" to extract transactions from the uploaded file.
                    {% else %}
                        No transactions found in this batch.
                    {% endif %}
                </p>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const batchId = {{ batch.batch_id }};
const baseUrl = '{{ base_url }}';
let isMatching = false;

// Check URL for filter state on page load
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const filterValue = urlParams.get('filter');
    if (filterValue) {
        const filterSelect = document.getElementById('transactionFilter');
        if (filterSelect) {
            filterSelect.value = filterValue;
            applyTransactionFilter();
        }
    }
});

// Helper to get current filter state for redirects
function getFilterParams() {
    const filterSelect = document.getElementById('transactionFilter');
    if (filterSelect && filterSelect.value !== 'all') {
        return '&filter=' + filterSelect.value;
    }
    return '';
}

function startMatching() {
    if (isMatching) return;
    isMatching = true;
    
    // Update UI
    document.getElementById('matchBtn').disabled = true;
    document.getElementById('matchBtn').innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Matching...';
    document.getElementById('matchProgress').style.display = 'block';
    
    const clearBtn = document.getElementById('clearBtn');
    if (clearBtn) clearBtn.style.display = 'none';
    
    // Start the matching process
    processMatchStep();
}

function processMatchStep() {
    fetch(baseUrl + 'import/batch/' + batchId + '/match-progress', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        updateProgress(data);
        
        if (data.status === 'fetching' || data.status === 'matching') {
            // Continue processing
            setTimeout(processMatchStep, 100);
        } else if (data.status === 'complete') {
            // Done - reload page to show results
            setTimeout(() => {
                window.location.href = baseUrl + 'import/batch/' + batchId + '?success=' + encodeURIComponent(data.message);
            }, 500);
        } else if (data.status === 'error') {
            showError(data.message);
        }
    })
    .catch(error => {
        showError('Request failed: ' + error.message);
    });
}

function updateProgress(data) {
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    
    let percent = 0;
    let message = data.message || 'Processing...';
    
    if (data.status === 'fetching') {
        const currentPage = data.current_page || 0;
        const totalPages = data.total_pages || 1;
        percent = Math.round((currentPage / totalPages) * 80); // 0-80% for fetching
        message = `Fetching from Akaunting: page ${currentPage} of ${totalPages} (${data.fetched_count || 0} transactions)`;
    } else if (data.status === 'matching') {
        percent = 90;
        message = `Matching ${data.fetched_count || 0} Akaunting transactions...`;
    } else if (data.status === 'complete') {
        percent = 100;
        progressBar.classList.remove('progress-bar-animated');
        progressBar.classList.add('bg-success');
        message = ` ${data.message}`;
    }
    
    progressBar.style.width = percent + '%';
    progressBar.setAttribute('aria-valuenow', percent);
    progressText.textContent = message;
}

function showError(message) {
    isMatching = false;
    
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    
    progressBar.classList.remove('progress-bar-animated');
    progressBar.classList.add('bg-danger');
    progressBar.style.width = '100%';
    progressText.innerHTML = '<span class="text-danger"><i class="bi bi-exclamation-triangle"></i> ' + message + '</span>';
    
    document.getElementById('matchBtn').disabled = false;
    document.getElementById('matchBtn').innerHTML = '<i class="bi bi-arrow-repeat"></i> Retry Matching';
    
    const clearBtn = document.getElementById('clearBtn');
    if (clearBtn) clearBtn.style.display = 'block';
}

function clearMatches() {
    if (!confirm('Are you sure you want to clear all matches?')) return;
    
    // First reset the job
    fetch(baseUrl + 'import/batch/' + batchId + '/match-reset', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        window.location.href = baseUrl + 'import/batch/' + batchId + '?success=Matches+cleared';
    })
    .catch(error => {
        alert('Failed to clear matches: ' + error.message);
    });
}

function applyTransactionFilter() {
    const filterSelect = document.getElementById('transactionFilter');
    const filterValue = filterSelect ? filterSelect.value : 'all';
    const rows = document.querySelectorAll('.transaction-table tbody tr');
    
    rows.forEach(row => {
        // Always hide push-row and replicate-row (they're toggled separately)
        if (row.classList.contains('push-row') || row.classList.contains('replicate-row')) {
            return;
        }
        
        if (filterValue === 'all') {
            // Show all except push-rows, replicate-rows, and match-rows (match-rows shown with their parent)
            if (!row.classList.contains('match-row')) {
                row.style.display = '';
            } else {
                // Show match row if parent has-match is visible
                row.style.display = '';
            }
        } else if (filterValue === 'hide-matched') {
            // Hide matched rows that are NOT pushed (only matched, not pushed)
            // Pushed transactions should still show even if they have a match
            if (row.classList.contains('match-row')) {
                // Hide match-row if parent is hidden (matched but not pushed)
                row.style.display = 'none';
            } else if (row.classList.contains('has-match') && !row.classList.contains('has-pushed')) {
                // Hide matched rows that are NOT pushed
                row.style.display = 'none';
            } else {
                row.style.display = '';
            }
        } else if (filterValue === 'hide-matched-pushed') {
            // Hide both matched AND pushed rows
            if (row.classList.contains('has-match') || row.classList.contains('match-row') || row.classList.contains('has-pushed')) {
                row.style.display = 'none';
            } else {
                row.style.display = '';
            }
        }
    });
    
    // Update the visible count in header
    const visibleCount = document.querySelectorAll('.transaction-table tbody tr:not(.match-row):not(.push-row):not(.replicate-row):not([style*="display: none"])').length;
    const headerTitle = document.querySelector('.card-header h5');
    if (headerTitle) {
        const totalCount = {{ transactions|length }};
        if (filterValue !== 'all') {
            headerTitle.innerHTML = '<i class="bi bi-list-ul"></i> Transactions (' + visibleCount + ' of ' + totalCount + ')';
        } else {
            headerTitle.innerHTML = '<i class="bi bi-list-ul"></i> Transactions (' + totalCount + ')';
        }
    }
}

let formDataCache = null;
let formDataLoading = false;

function togglePushRow(transactionId) {
    const pushRow = document.getElementById('push-row-' + transactionId);
    if (pushRow) {
        if (pushRow.style.display === 'none') {
            // Close any other open push rows first
            document.querySelectorAll('.push-row').forEach(row => {
                row.style.display = 'none';
            });
            pushRow.style.display = '';
            
            // Load form data for this row
            loadFormDataForRow(transactionId);
        } else {
            pushRow.style.display = 'none';
        }
    }
}

function loadFormDataForRow(transactionId) {
    const contactSelect = document.getElementById('contact-select-' + transactionId);
    const categorySelect = document.getElementById('category-select-' + transactionId);
    const paymentSelect = document.getElementById('payment-select-' + transactionId);
    const description = contactSelect.dataset.description || '';
    
    // If we already have cached data, use it
    if (formDataCache) {
        populateFormSelects(transactionId, formDataCache, description);
        return;
    }
    
    // If already loading, wait
    if (formDataLoading) {
        setTimeout(() => loadFormDataForRow(transactionId), 100);
        return;
    }
    
    formDataLoading = true;
    contactSelect.innerHTML = '<option value="">Loading...</option>';
    categorySelect.innerHTML = '<option value="">Loading...</option>';
    paymentSelect.innerHTML = '<option value="">Loading...</option>';
    
    fetch(baseUrl + 'import/batch/' + batchId + '/vendors?description=' + encodeURIComponent(description), {
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        formDataLoading = false;
        if (data.success) {
            formDataCache = {
                vendors: data.vendors || [],
                customers: data.customers || [],
                categories: data.categories || [],
                payment_methods: data.payment_methods || [],
                akaunting_accounts: data.akaunting_accounts || [],
                suggested: data.suggested
            };
            populateFormSelects(transactionId, formDataCache, description);
        } else {
            contactSelect.innerHTML = '<option value="">Error loading</option>';
            categorySelect.innerHTML = '<option value="">Error loading</option>';
            paymentSelect.innerHTML = '<option value="">Error loading</option>';
        }
    })
    .catch(error => {
        formDataLoading = false;
        console.error('Error loading form data:', error);
        contactSelect.innerHTML = '<option value="">Error loading</option>';
        categorySelect.innerHTML = '<option value="">Error loading</option>';
        paymentSelect.innerHTML = '<option value="">Error loading</option>';
    });
}

function populateFormSelects(transactionId, data, description) {
    // Get the type select to determine contact type (vendor/customer) and category filter
    const typeSelect = document.getElementById('type-select-' + transactionId);
    const selectedType = typeSelect ? typeSelect.value : 'expense';
    
    // Populate contacts (vendors for expense, customers for income)
    populateContactSelect(transactionId, data, selectedType);
    
    // Populate categories (filtered by type)
    populateCategorySelect(transactionId, data, selectedType);
    
    // Populate payment methods
    populatePaymentSelect(transactionId, data);
}

// Called when transaction type changes
function onTypeChange(transactionId, amount) {
    const typeSelect = document.getElementById('type-select-' + transactionId);
    const selectedType = typeSelect ? typeSelect.value : 'expense';
    
    // Get field containers
    const contactCategoryField = document.getElementById('contact-category-' + transactionId);
    const categoryField = document.getElementById('category-field-' + transactionId);
    const sourceField = document.getElementById('source-field-' + transactionId);
    const destField = document.getElementById('dest-field-' + transactionId);
    const contactSelect = document.getElementById('contact-select-' + transactionId);
    const categorySelect = document.getElementById('category-select-' + transactionId);
    
    if (selectedType === 'transfer') {
        // Hide contact/category, show source/destination
        if (contactCategoryField) contactCategoryField.style.display = 'none';
        if (categoryField) categoryField.style.display = 'none';
        if (sourceField) sourceField.style.display = '';
        if (destField) destField.style.display = '';
        
        // Remove required from hidden fields
        if (contactSelect) contactSelect.required = false;
        if (categorySelect) categorySelect.required = false;
        
        // Populate transfer fields
        if (formDataCache) {
            // Get amount from data attribute if not passed
            if (amount === undefined) {
                amount = parseFloat(typeSelect.dataset.amount || 0);
            }
            populateTransferFields(transactionId, formDataCache, amount);
        }
    } else {
        // Show contact/category, hide source/destination
        if (contactCategoryField) contactCategoryField.style.display = '';
        if (categoryField) categoryField.style.display = '';
        if (sourceField) sourceField.style.display = 'none';
        if (destField) destField.style.display = 'none';
        
        // Restore required on visible fields
        if (contactSelect) contactSelect.required = true;
        if (categorySelect) categorySelect.required = true;
        
        // Update contact label and dropdown
        const contactLabel = document.getElementById('contact-label-' + transactionId);
        if (contactLabel) {
            contactLabel.textContent = selectedType === 'expense' ? 'Vendor' : 'Customer';
        }
        
        // Re-populate contacts with correct type
        if (formDataCache) {
            populateContactSelect(transactionId, formDataCache, selectedType);
            populateCategorySelect(transactionId, formDataCache, selectedType);
        }
    }
}

// Populate transfer source/destination fields
function populateTransferFields(transactionId, data, amount) {
    const sourceSelect = document.getElementById('source-select-' + transactionId);
    const destSelect = document.getElementById('dest-select-' + transactionId);
    const accounts = data.akaunting_accounts || [];
    
    // Current account info from template
    const thisAccountId = {{ akaunting_account_id ?? 'null' }};
    const thisAccountName = '{{ akaunting_account_name ?? "" }}';
    const thisAccountCurrency = '{{ akaunting_account_currency ?? "TTD" }}';
    
    // Positive amount = money coming IN, so destination is this account, source is dropdown
    // Negative amount = money going OUT, so source is this account, destination is dropdown
    const isPositive = amount >= 0;
    
    // Helper to build option with currency
    function buildOption(acc, isThisAccount = false) {
        const currency = acc.currency_code || 'TTD';
        let label = acc.name;
        if (acc.number) label += ' (' + acc.number + ')';
        label += ' [' + currency + ']';
        if (isThisAccount) label += ' (this account)';
        return { label, currency };
    }
    
    if (isPositive) {
        // Positive: destination = this account (fixed), source = dropdown
        const thisOpt = buildOption({ name: thisAccountName, currency_code: thisAccountCurrency }, true);
        destSelect.innerHTML = '<option value="' + thisAccountId + '" data-currency="' + thisAccountCurrency + '" selected>' + thisOpt.label + '</option>';
        destSelect.disabled = true;
        
        sourceSelect.innerHTML = '<option value="" data-currency="">-- Select Source Account --</option>';
        sourceSelect.disabled = false;
        accounts.forEach(acc => {
            if (acc.id !== thisAccountId) {
                const opt = buildOption(acc);
                sourceSelect.innerHTML += '<option value="' + acc.id + '" data-currency="' + opt.currency + '">' + opt.label + '</option>';
            }
        });
    } else {
        // Negative: source = this account (fixed), destination = dropdown
        const thisOpt = buildOption({ name: thisAccountName, currency_code: thisAccountCurrency }, true);
        sourceSelect.innerHTML = '<option value="' + thisAccountId + '" data-currency="' + thisAccountCurrency + '" selected>' + thisOpt.label + '</option>';
        sourceSelect.disabled = true;
        
        destSelect.innerHTML = '<option value="" data-currency="">-- Select Destination Account --</option>';
        destSelect.disabled = false;
        accounts.forEach(acc => {
            if (acc.id !== thisAccountId) {
                const opt = buildOption(acc);
                destSelect.innerHTML += '<option value="' + acc.id + '" data-currency="' + opt.currency + '">' + opt.label + '</option>';
            }
        });
    }
    
    // Add change listener to check for currency mismatch
    const activeSelect = isPositive ? sourceSelect : destSelect;
    activeSelect.addEventListener('change', function() {
        checkTransferCurrencyMismatch(transactionId, sourceSelect, destSelect);
    });
}

// Check if source and destination currencies differ
function checkTransferCurrencyMismatch(transactionId, sourceSelect, destSelect) {
    const sourceOption = sourceSelect.options[sourceSelect.selectedIndex];
    const destOption = destSelect.options[destSelect.selectedIndex];
    
    const sourceCurrency = sourceOption ? sourceOption.dataset.currency : '';
    const destCurrency = destOption ? destOption.dataset.currency : '';
    
    const singleAmountField = document.getElementById('single-amount-field-' + transactionId);
    const currencyExchangeStack = document.getElementById('currency-exchange-stack-' + transactionId);
    const amountInput = document.getElementById('amount-input-' + transactionId);
    const destAmountInput = document.getElementById('dest-amount-' + transactionId);
    const exchangeRateInput = document.getElementById('exchange-rate-' + transactionId);
    const exchangeRateDisplay = document.getElementById('exchange-rate-display-' + transactionId);
    const sourceAmountLabel = document.getElementById('source-amount-label-' + transactionId);
    const destAmountLabel = document.getElementById('dest-amount-label-' + transactionId);
    
    // Show currency exchange fields if currencies differ and both are selected
    const currenciesDiffer = sourceCurrency && destCurrency && sourceCurrency !== destCurrency;
    
    if (currenciesDiffer) {
        // Hide single amount, show stacked exchange fields
        singleAmountField.style.display = 'none';
        currencyExchangeStack.style.display = '';
        destAmountInput.required = true;
        
        // Update labels to show currencies
        if (sourceAmountLabel) sourceAmountLabel.textContent = 'Source (' + sourceCurrency + ')';
        if (destAmountLabel) destAmountLabel.textContent = 'Dest (' + destCurrency + ')';
    } else {
        // Show single amount, hide stacked exchange fields
        singleAmountField.style.display = '';
        currencyExchangeStack.style.display = 'none';
        destAmountInput.required = false;
        destAmountInput.value = '';
        exchangeRateInput.value = '';
        exchangeRateDisplay.value = '';
    }
}

// Calculate exchange rate based on source amount and destination amount
function calculateExchangeRate(transactionId) {
    // Get source amount from the display field (readonly, always has the original amount)
    const sourceAmountDisplay = document.getElementById('source-amount-display-' + transactionId);
    const destAmountInput = document.getElementById('dest-amount-' + transactionId);
    const exchangeRateInput = document.getElementById('exchange-rate-' + transactionId);
    const exchangeRateDisplay = document.getElementById('exchange-rate-display-' + transactionId);
    
    const sourceAmount = parseFloat(sourceAmountDisplay.value) || 0;
    const destAmount = parseFloat(destAmountInput.value) || 0;
    
    if (sourceAmount > 0 && destAmount > 0) {
        // Exchange rate = destination amount / source amount
        const rate = destAmount / sourceAmount;
        exchangeRateInput.value = rate.toFixed(6);
        exchangeRateDisplay.value = rate.toFixed(4);
    } else {
        exchangeRateInput.value = '';
        exchangeRateDisplay.value = '--';
    }
}

function populateContactSelect(transactionId, data, type) {
    const select = document.getElementById('contact-select-' + transactionId);
    const hiddenInput = document.getElementById('contact-name-' + transactionId);
    
    // Use vendors for expense, customers for income
    const isExpense = type === 'expense';
    const contacts = isExpense ? (data.vendors || []) : (data.customers || []);
    const label = isExpense ? 'Vendor' : 'Customer';
    
    // Clear and add placeholder
    select.innerHTML = '<option value="">-- Select ' + label + ' --</option>';
    
    // Check for suggested contact
    let suggestedId = data.suggested?.vendor_id || null;
    
    // Add all contacts
    contacts.forEach(contact => {
        const option = document.createElement('option');
        option.value = contact.akaunting_contact_id;
        option.textContent = contact.name;
        option.dataset.name = contact.name;
        
        // Pre-select if suggested (only for expense/vendor)
        if (isExpense && suggestedId && contact.akaunting_contact_id == suggestedId) {
            option.selected = true;
            hiddenInput.value = contact.name;
        }
        
        select.appendChild(option);
    });
    
    // Add change handler to update hidden input
    select.onchange = function() {
        const selectedOption = this.options[this.selectedIndex];
        hiddenInput.value = selectedOption.dataset.name || '';
    };
}

function populateCategorySelect(transactionId, data, type) {
    const select = document.getElementById('category-select-' + transactionId);
    const hiddenInput = document.getElementById('category-name-' + transactionId);
    
    // Clear and add placeholder
    select.innerHTML = '<option value="">-- Select Category --</option>';
    
    // Check for suggested category
    let suggestedId = data.suggested?.category_id || null;
    
    // Filter categories by type (expense/income)
    const filteredCategories = (data.categories || []).filter(cat => {
        return !cat.type || cat.type === type || cat.type === 'other';
    });
    
    // Add categories
    filteredCategories.forEach(category => {
        const option = document.createElement('option');
        option.value = category.akaunting_category_id;
        option.textContent = category.name;
        option.dataset.name = category.name;
        
        // Pre-select if suggested
        if (suggestedId && category.akaunting_category_id == suggestedId) {
            option.selected = true;
            hiddenInput.value = category.name;
        }
        
        select.appendChild(option);
    });
    
    // Add change handler to update hidden input
    select.onchange = function() {
        const selectedOption = this.options[this.selectedIndex];
        hiddenInput.value = selectedOption.dataset.name || '';
    };
}

function populatePaymentSelect(transactionId, data) {
    const select = document.getElementById('payment-select-' + transactionId);
    
    // Clear and add placeholder
    select.innerHTML = '<option value="">-- Select --</option>';
    
    // Check for suggested payment method
    let suggestedMethod = data.suggested?.payment_method || 'bank_transfer';
    
    // Add payment methods
    (data.payment_methods || []).forEach(method => {
        const option = document.createElement('option');
        option.value = method.code;
        option.textContent = method.name;
        
        // Pre-select if suggested or default
        if (method.code === suggestedMethod) {
            option.selected = true;
        }
        
        select.appendChild(option);
    });
    
    // If no payment methods loaded, add defaults
    if (!data.payment_methods || data.payment_methods.length === 0) {
        const defaults = [
            {code: 'cash', name: 'Cash'},
            {code: 'bank_transfer', name: 'Bank Transfer'},
            {code: 'credit_card', name: 'Credit Card'}
        ];
        defaults.forEach(method => {
            const option = document.createElement('option');
            option.value = method.code;
            option.textContent = method.name;
            if (method.code === 'bank_transfer') option.selected = true;
            select.appendChild(option);
        });
    }
}

function pushToAkaunting(transactionId, event) {
    event.preventDefault();
    
    const form = document.getElementById('push-form-' + transactionId);
    const formData = new FormData(form);
    const transactionType = formData.get('type');
    
    const data = {
        transaction_id: transactionId,
        date: formData.get('date'),
        reference: formData.get('reference'),
        payment_method: formData.get('payment_method') || 'bank_transfer',
        type: transactionType,
        amount: parseFloat(formData.get('amount'))
    };
    
    if (transactionType === 'transfer') {
        // For transfers, get source and destination account IDs
        const sourceSelect = document.getElementById('source-select-' + transactionId);
        const destSelect = document.getElementById('dest-select-' + transactionId);
        
        data.from_account_id = parseInt(sourceSelect.value) || null;
        data.to_account_id = parseInt(destSelect.value) || null;
        
        // Check for currency exchange data
        const destAmountInput = document.getElementById('dest-amount-' + transactionId);
        const exchangeRateInput = document.getElementById('exchange-rate-' + transactionId);
        
        // Get currencies from selected options
        const sourceOption = sourceSelect.options[sourceSelect.selectedIndex];
        const destOption = destSelect.options[destSelect.selectedIndex];
        const sourceCurrency = sourceOption ? sourceOption.dataset.currency : null;
        const destCurrency = destOption ? destOption.dataset.currency : null;
        
        // If currencies differ, include exchange rate data
        if (sourceCurrency && destCurrency && sourceCurrency !== destCurrency) {
            const toAmount = parseFloat(destAmountInput.value) || 0;
            const rate = parseFloat(exchangeRateInput.value) || 0;
            
            if (!toAmount || toAmount <= 0) {
                alert('Please enter the destination amount in ' + destCurrency);
                return false;
            }
            
            data.to_amount = toAmount;
            data.currency_rate = rate;
            data.from_currency = sourceCurrency;
            data.to_currency = destCurrency;
        }
        
        // Validate transfer fields
        if (!data.from_account_id) {
            alert('Please select a source account');
            return false;
        }
        if (!data.to_account_id) {
            alert('Please select a destination account');
            return false;
        }
    } else {
        // For expense/income, get contact and category
        data.contact_id = parseInt(formData.get('contact_id')) || null;
        data.contact = formData.get('contact');
        data.category_id = parseInt(formData.get('category_id')) || 1;
        data.category_name = formData.get('category_name');
        
        // Validate required fields
        if (!data.contact_id) {
            alert('Please select a vendor');
            return false;
        }
        if (!data.category_id) {
            alert('Please select a category');
            return false;
        }
    }
    
    // Disable the submit button
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalHtml = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    
    fetch(baseUrl + 'import/batch/' + batchId + '/push-transaction', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin',
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // Success - reload page to show updated status, preserving filter state
            window.location.href = baseUrl + 'import/batch/' + batchId + '?success=' + encodeURIComponent('Transaction pushed to Akaunting') + getFilterParams();
        } else {
            alert('Error: ' + (result.message || 'Failed to push transaction'));
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalHtml;
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalHtml;
    });
    
    return false;
}

// =============================================
// Cross-Entity Replication Functions
// =============================================

// Cache for entities with installations
let entitiesCache = null;
// Cache for installation form data (keyed by installation_id)
let installationFormDataCache = {};
// Current entity's installation ID (for source mapping info)
const sourceInstallationId = {{ batch.installation_id ?? 'null' }};

// Toggle replicate row visibility
function toggleReplicateRow(transactionId) {
    const row = document.getElementById('replicate-row-' + transactionId);
    if (row) {
        const isHidden = row.style.display === 'none';
        row.style.display = isHidden ? '' : 'none';
        
        // Load entities list on first open
        if (isHidden) {
            loadEntitiesForReplicate(transactionId);
        }
    }
}

// Load entities with installations
function loadEntitiesForReplicate(transactionId) {
    const entitySelect = document.getElementById('replicate-entity-' + transactionId);
    
    // Use cache if available
    if (entitiesCache) {
        populateEntitySelect(transactionId, entitiesCache);
        return;
    }
    
    entitySelect.innerHTML = '<option value="">Loading...</option>';
    
    // Exclude current entity from list
    const excludeEntity = {{ batch.entity_id ?? 'null' }};
    let url = baseUrl + 'api/entities-with-installations';
    if (excludeEntity) {
        url += '?exclude_entity=' + excludeEntity;
    }
    
    fetch(url, { credentials: 'same-origin' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                entitiesCache = data.entities || [];
                populateEntitySelect(transactionId, entitiesCache);
            } else {
                entitySelect.innerHTML = '<option value="">Error loading</option>';
            }
        })
        .catch(error => {
            console.error('Error loading entities:', error);
            entitySelect.innerHTML = '<option value="">Error loading</option>';
        });
}

// Populate entity select dropdown
function populateEntitySelect(transactionId, entities) {
    const entitySelect = document.getElementById('replicate-entity-' + transactionId);
    
    entitySelect.innerHTML = '<option value="">-- Select Entity --</option>';
    
    entities.forEach(entity => {
        const option = document.createElement('option');
        option.value = entity.entity_id;
        option.textContent = entity.entity_name;
        option.dataset.installationId = entity.installation_id;
        entitySelect.appendChild(option);
    });
}

// Called when entity is selected in replicate form
function onReplicateEntityChange(transactionId) {
    const entitySelect = document.getElementById('replicate-entity-' + transactionId);
    const installationInput = document.getElementById('replicate-installation-' + transactionId);
    const accountSelect = document.getElementById('replicate-account-' + transactionId);
    const contactSelect = document.getElementById('replicate-contact-' + transactionId);
    const categorySelect = document.getElementById('replicate-category-' + transactionId);
    const paymentSelect = document.getElementById('replicate-payment-' + transactionId);
    
    const selectedOption = entitySelect.options[entitySelect.selectedIndex];
    const installationId = selectedOption.dataset.installationId;
    
    if (!installationId) {
        accountSelect.innerHTML = '<option value="">Select entity first</option>';
        contactSelect.innerHTML = '<option value="">Select entity first</option>';
        categorySelect.innerHTML = '<option value="">Select entity first</option>';
        paymentSelect.innerHTML = '<option value="">Select entity first</option>';
        return;
    }
    
    installationInput.value = installationId;
    
    // Show loading state
    accountSelect.innerHTML = '<option value="">Loading...</option>';
    contactSelect.innerHTML = '<option value="">Loading...</option>';
    categorySelect.innerHTML = '<option value="">Loading...</option>';
    paymentSelect.innerHTML = '<option value="">Loading...</option>';
    
    // Get source vendor/category for mapping lookup
    const form = document.getElementById('replicate-form-' + transactionId);
    const sourceVendorId = form.querySelector('[name="source_vendor_id"]').value;
    const sourceCategoryId = form.querySelector('[name="source_category_id"]').value;
    
    // Check cache first
    if (installationFormDataCache[installationId]) {
        populateReplicateFormSelects(transactionId, installationFormDataCache[installationId]);
        return;
    }
    
    // Fetch form data for this installation
    let url = baseUrl + 'api/installations/' + installationId + '/form-data';
    if (sourceInstallationId) {
        url += '?source_installation_id=' + sourceInstallationId;
        if (sourceVendorId) url += '&source_vendor_id=' + sourceVendorId;
        if (sourceCategoryId) url += '&source_category_id=' + sourceCategoryId;
    }
    
    fetch(url, { credentials: 'same-origin' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                installationFormDataCache[installationId] = data;
                populateReplicateFormSelects(transactionId, data);
            } else {
                accountSelect.innerHTML = '<option value="">Error loading</option>';
                contactSelect.innerHTML = '<option value="">Error loading</option>';
                categorySelect.innerHTML = '<option value="">Error loading</option>';
                paymentSelect.innerHTML = '<option value="">Error loading</option>';
            }
        })
        .catch(error => {
            console.error('Error loading installation form data:', error);
            accountSelect.innerHTML = '<option value="">Error loading</option>';
            contactSelect.innerHTML = '<option value="">Error loading</option>';
            categorySelect.innerHTML = '<option value="">Error loading</option>';
            paymentSelect.innerHTML = '<option value="">Error loading</option>';
        });
}

// Populate all dropdowns in replicate form
function populateReplicateFormSelects(transactionId, data) {
    const typeSelect = document.getElementById('replicate-type-' + transactionId);
    const selectedType = typeSelect ? typeSelect.value : 'expense';
    const suggested = data.suggested || {};
    
    // Populate accounts with currency
    const accountSelect = document.getElementById('replicate-account-' + transactionId);
    accountSelect.innerHTML = '<option value="" data-currency="">-- Select Account --</option>';
    (data.accounts || []).forEach(acc => {
        const option = document.createElement('option');
        option.value = acc.id;
        const currency = acc.currency_code || 'TTD';
        let label = acc.name;
        if (acc.number) label += ' (' + acc.number + ')';
        label += ' [' + currency + ']';
        option.textContent = label;
        option.dataset.currency = currency;
        if (suggested.target_account_id && acc.id == suggested.target_account_id) {
            option.selected = true;
        }
        accountSelect.appendChild(option);
    });
    
    // Add change listener to check for currency mismatch
    accountSelect.addEventListener('change', function() {
        checkReplicateCurrencyMismatch(transactionId);
    });
    
    // Populate contacts (vendors or customers based on type)
    populateReplicateContactSelect(transactionId, data, selectedType, suggested);
    
    // Populate categories
    populateReplicateCategorySelect(transactionId, data, selectedType, suggested);
    
    // Populate payment methods
    const paymentSelect = document.getElementById('replicate-payment-' + transactionId);
    paymentSelect.innerHTML = '<option value="">-- Select --</option>';
    const suggestedPayment = suggested.target_payment_method || 'bank_transfer';
    (data.payment_methods || []).forEach(method => {
        const option = document.createElement('option');
        option.value = method.code;
        option.textContent = method.name;
        if (method.code === suggestedPayment) {
            option.selected = true;
        }
        paymentSelect.appendChild(option);
    });
}

// Populate contact select in replicate form
function populateReplicateContactSelect(transactionId, data, type, suggested) {
    const contactSelect = document.getElementById('replicate-contact-' + transactionId);
    const hiddenInput = document.getElementById('replicate-contact-name-' + transactionId);
    
    const isExpense = type === 'expense';
    const contacts = isExpense ? (data.vendors || []) : (data.customers || []);
    const label = isExpense ? 'Vendor' : 'Customer';
    
    contactSelect.innerHTML = '<option value="">-- Select ' + label + ' --</option>';
    
    const suggestedId = suggested.target_vendor_id || null;
    
    contacts.forEach(contact => {
        const option = document.createElement('option');
        option.value = contact.id;
        option.textContent = contact.name;
        option.dataset.name = contact.name;
        if (suggestedId && contact.id == suggestedId) {
            option.selected = true;
            hiddenInput.value = contact.name;
        }
        contactSelect.appendChild(option);
    });
    
    contactSelect.onchange = function() {
        const selectedOption = this.options[this.selectedIndex];
        hiddenInput.value = selectedOption.dataset.name || '';
    };
}

// Populate category select in replicate form
function populateReplicateCategorySelect(transactionId, data, type, suggested) {
    const categorySelect = document.getElementById('replicate-category-' + transactionId);
    const hiddenInput = document.getElementById('replicate-category-name-' + transactionId);
    
    categorySelect.innerHTML = '<option value="">-- Select Category --</option>';
    
    const suggestedId = suggested.target_category_id || null;
    
    // Filter categories by type
    const filteredCategories = (data.categories || []).filter(cat => {
        return !cat.type || cat.type === type || cat.type === 'other';
    });
    
    filteredCategories.forEach(category => {
        const option = document.createElement('option');
        option.value = category.id;
        option.textContent = category.name;
        option.dataset.name = category.name;
        if (suggestedId && category.id == suggestedId) {
            option.selected = true;
            hiddenInput.value = category.name;
        }
        categorySelect.appendChild(option);
    });
    
    categorySelect.onchange = function() {
        const selectedOption = this.options[this.selectedIndex];
        hiddenInput.value = selectedOption.dataset.name || '';
    };
}

// Check if source and destination currencies differ for replication
function checkReplicateCurrencyMismatch(transactionId) {
    const form = document.getElementById('replicate-form-' + transactionId);
    const sourceCurrency = form.querySelector('[name="source_currency"]').value;
    
    const accountSelect = document.getElementById('replicate-account-' + transactionId);
    const selectedOption = accountSelect.options[accountSelect.selectedIndex];
    const destCurrency = selectedOption ? selectedOption.dataset.currency : '';
    
    const singleAmountField = document.getElementById('replicate-single-amount-field-' + transactionId);
    const currencyExchangeStack = document.getElementById('replicate-currency-exchange-stack-' + transactionId);
    const destAmountInput = document.getElementById('replicate-dest-amount-' + transactionId);
    const sourceAmountLabel = document.getElementById('replicate-source-amount-label-' + transactionId);
    const destAmountLabel = document.getElementById('replicate-dest-amount-label-' + transactionId);
    const exchangeRateInput = document.getElementById('replicate-exchange-rate-' + transactionId);
    const exchangeRateDisplay = document.getElementById('replicate-exchange-rate-display-' + transactionId);
    
    // Show currency exchange fields if currencies differ and both are selected
    const currenciesDiffer = sourceCurrency && destCurrency && sourceCurrency !== destCurrency;
    
    if (currenciesDiffer) {
        // Hide single amount, show stacked exchange fields
        singleAmountField.style.display = 'none';
        currencyExchangeStack.style.display = '';
        destAmountInput.required = true;
        
        // Update labels to show currencies
        if (sourceAmountLabel) sourceAmountLabel.textContent = 'Source (' + sourceCurrency + ')';
        if (destAmountLabel) destAmountLabel.textContent = 'Dest (' + destCurrency + ')';
    } else {
        // Show single amount, hide stacked exchange fields
        singleAmountField.style.display = '';
        currencyExchangeStack.style.display = 'none';
        destAmountInput.required = false;
        destAmountInput.value = '';
        exchangeRateInput.value = '';
        exchangeRateDisplay.value = '';
    }
}

// Calculate exchange rate for replication based on source amount and destination amount
function calculateReplicateExchangeRate(transactionId) {
    // Get source amount from the display field (readonly, always has the original amount)
    const sourceAmountDisplay = document.getElementById('replicate-source-amount-display-' + transactionId);
    const destAmountInput = document.getElementById('replicate-dest-amount-' + transactionId);
    const exchangeRateInput = document.getElementById('replicate-exchange-rate-' + transactionId);
    const exchangeRateDisplay = document.getElementById('replicate-exchange-rate-display-' + transactionId);
    
    const sourceAmount = parseFloat(sourceAmountDisplay.value) || 0;
    const destAmount = parseFloat(destAmountInput.value) || 0;
    
    if (sourceAmount > 0 && destAmount > 0) {
        // Exchange rate = destination amount / source amount
        const rate = destAmount / sourceAmount;
        exchangeRateInput.value = rate.toFixed(6);
        exchangeRateDisplay.value = rate.toFixed(4);
    } else {
        exchangeRateInput.value = '';
        exchangeRateDisplay.value = '--';
    }
}

// Called when type changes in replicate form
function onReplicateTypeChange(transactionId) {
    const typeSelect = document.getElementById('replicate-type-' + transactionId);
    const selectedType = typeSelect.value;
    const installationInput = document.getElementById('replicate-installation-' + transactionId);
    const installationId = installationInput.value;
    
    // Update contact label
    const contactLabel = document.getElementById('replicate-contact-label-' + transactionId);
    if (contactLabel) {
        contactLabel.textContent = selectedType === 'expense' ? 'Vendor' : 'Customer';
    }
    
    // Re-populate contacts and categories with cached data
    if (installationId && installationFormDataCache[installationId]) {
        const data = installationFormDataCache[installationId];
        populateReplicateContactSelect(transactionId, data, selectedType, data.suggested || {});
        populateReplicateCategorySelect(transactionId, data, selectedType, data.suggested || {});
    }
}

// Submit replicate form
function replicateToEntity(transactionId, event) {
    event.preventDefault();
    
    const form = document.getElementById('replicate-form-' + transactionId);
    const formData = new FormData(form);
    
    const data = {
        source_transaction_id: parseInt(formData.get('source_transaction_id')),
        source_vendor_id: parseInt(formData.get('source_vendor_id')) || null,
        source_category_id: parseInt(formData.get('source_category_id')) || null,
        entity_id: parseInt(formData.get('entity_id')),
        installation_id: parseInt(formData.get('installation_id')),
        account_id: parseInt(formData.get('account_id')),
        date: formData.get('date'),
        reference: formData.get('reference'),
        type: formData.get('type'),
        contact_id: parseInt(formData.get('contact_id')) || null,
        contact_name: formData.get('contact_name'),
        category_id: parseInt(formData.get('category_id')) || null,
        category_name: formData.get('category_name'),
        payment_method: formData.get('payment_method'),
        amount: parseFloat(formData.get('amount'))
    };
    
    // Check for currency exchange data
    const sourceCurrency = formData.get('source_currency');
    const accountSelect = document.getElementById('replicate-account-' + transactionId);
    const selectedOption = accountSelect.options[accountSelect.selectedIndex];
    const destCurrency = selectedOption ? selectedOption.dataset.currency : null;
    
    // If currencies differ, include exchange rate data
    if (sourceCurrency && destCurrency && sourceCurrency !== destCurrency) {
        const toAmount = parseFloat(formData.get('to_amount')) || 0;
        const rate = parseFloat(formData.get('currency_rate')) || 0;
        
        if (!toAmount || toAmount <= 0) {
            alert('Please enter the destination amount in ' + destCurrency);
            return false;
        }
        
        data.to_amount = toAmount;
        data.currency_rate = rate;
        data.source_currency = sourceCurrency;
        data.dest_currency = destCurrency;
    }
    
    // Validate required fields
    if (!data.installation_id || !data.account_id) {
        alert('Please select an entity and account');
        return false;
    }
    if (!data.contact_id) {
        alert('Please select a vendor/customer');
        return false;
    }
    if (!data.category_id) {
        alert('Please select a category');
        return false;
    }
    
    // Disable the submit button
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalHtml = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    
    fetch(baseUrl + 'import/batch/' + batchId + '/replicate-transaction', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        credentials: 'same-origin',
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // Success - just close the row, no dialog needed
            toggleReplicateRow(transactionId);
            // Optionally reload to show updated status
            window.location.reload();
        } else {
            alert('Error: ' + (result.message || 'Failed to replicate transaction'));
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalHtml;
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalHtml;
    });
    
    return false;
}

// Refresh vendors and categories cache
function refreshVendorsCategories() {
    const btn = document.getElementById('refresh-cache-btn');
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> Refreshing...';
    
    fetch('{{ base_url }}import/batch/{{ batch.batch_id }}/vendors?refresh=1')
        .then(response => response.json())
        .then(data => {
            btn.disabled = false;
            if (data.success) {
                btn.innerHTML = '<i class="bi bi-check"></i> Refreshed!';
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                }, 2000);
            } else {
                btn.innerHTML = '<i class="bi bi-x"></i> Failed';
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                }, 2000);
                alert('Failed to refresh: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
            alert('Error refreshing cache: ' + error.message);
        });
}
</script>
{% endblock %}
